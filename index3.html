<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA SOS æ±‚æ•‘ç‡ˆè™Ÿ333</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            transition: background-color 0.1s;
        }

        /* è¢å¹•é–ƒçˆçš„ CSS æ¨£å¼ */
        .flash-screen {
            background-color: white !important;
        }

        .container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: white;
            transition: background-color 0.3s;
        }

        #toggleButton {
            background-color: #4CAF50; /* Green */
        }

        #toggleButton.stop {
            background-color: #f44336; /* Red */
        }

        #status {
            margin-top: 20px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ SOS æ±‚æ•‘ç‡ˆè™Ÿ PWA</h1>
        <p>é»æ“ŠæŒ‰éˆ•ï¼Œé–‹å§‹ç™¼é€æ‘©æ–¯é›»ç¢¼ SOS (Â·Â·Â· --- Â·Â·Â·) è¨Šè™Ÿã€‚</p>
        
        <button id="toggleButton">
            å•Ÿå‹• SOS è¨Šè™Ÿ
        </button>

        <p id="status">ç‹€æ…‹ï¼šå¾…æ©Ÿä¸­</p>
        <p style="font-size: 12px; color: #666; max-width: 300px; margin-top: 15px;">
            **ğŸ’¡ å‚™è¨»ï¼š** æ‰‹é›»ç­’åŠŸèƒ½ä¸»è¦åœ¨æ”¯æ´ WebRTC `torch` åƒæ•¸çš„ç€è¦½å™¨ï¼ˆå¦‚ Android Chromeï¼‰ä¸Šé‹ä½œã€‚åœ¨å…¶ä»–å¹³å°ä¸Šï¼Œå°‡æœƒä»¥**è¢å¹•é–ƒçˆ**ä½œç‚ºå‚™ç”¨æ±‚æ•‘è¨Šè™Ÿã€‚
        </p>
    </div>

    <script>
        const button = document.getElementById('toggleButton');
        const statusDisplay = document.getElementById('status');
        const body = document.body;

        let isRunning = false;
        let videoTrack = null;
        let timerId = null;

        // æ‘©æ–¯é›»ç¢¼ SOS å®šç¾©
        // çŸ­é» (dot): 1 å–®ä½æ™‚é–“ (e.g., 200ms)
        // é•·åŠƒ (dash): 3 å–®ä½æ™‚é–“ (e.g., 600ms)
        // ç¬¦è™Ÿé–“éš”: 1 å–®ä½æ™‚é–“
        // å­—æ¯é–“éš”: 3 å–®ä½æ™‚é–“
        // å–®è©é–“éš”: 7 å–®ä½æ™‚é–“
        const UNIT_TIME = 200; // åŸºç¤å–®ä½æ™‚é–“ (æ¯«ç§’)

        // å®Œæ•´çš„ SOS åºåˆ—ï¼š
        // S (Â·Â·Â·) + ä¼‘æ¯ + O (---) + ä¼‘æ¯ + S (Â·Â·Â·) + ä¼‘æ¯ (é•·é–“éš”)
        const MORSE_CODE_SEQUENCE = [
            // S (Â·)
            { duration: UNIT_TIME, on: true }, { duration: UNIT_TIME, on: false },
            // S (Â·)
            { duration: UNIT_TIME, on: true }, { duration: UNIT_TIME, on: false },
            // S (Â·)
            { duration: UNIT_TIME, on: true }, { duration: UNIT_TIME * 3, on: false }, // å­—æ¯é–“éš”

            // O (-)
            { duration: UNIT_TIME * 3, on: true }, { duration: UNIT_TIME, on: false },
            // O (-)
            { duration: UNIT_TIME * 3, on: true }, { duration: UNIT_TIME, on: false },
            // O (-)
            { duration: UNIT_TIME * 3, on: true }, { duration: UNIT_TIME * 3, on: false }, // å­—æ¯é–“éš”

            // S (Â·)
            { duration: UNIT_TIME, on: true }, { duration: UNIT_TIME, on: false },
            // S (Â·)
            { duration: UNIT_TIME, on: true }, { duration: UNIT_TIME, on: false },
            // S (Â·)
            { duration: UNIT_TIME, on: true }, { duration: UNIT_TIME * 7, on: false }, // å–®è©é–“éš” (é‡è¤‡å¾ªç’°)
        ];

        // --- æ ¸å¿ƒæ‰‹é›»ç­’æ§åˆ¶å‡½å¼ ---

        /**
         * é–‹å•Ÿ/é—œé–‰æ‰‹é›»ç­’ (ç›¸æ©Ÿé–ƒå…‰ç‡ˆ)
         * @param {boolean} state - true ç‚ºé–‹å•Ÿ, false ç‚ºé—œé–‰
         */
        async function setTorch(state) {
            if (!videoTrack) {
                // å¦‚æœæ²’æœ‰è¦–è¨Šè»Œé“ï¼Œå‰‡åŸ·è¡Œè¢å¹•é–ƒçˆå‚™ç”¨æ–¹æ¡ˆ
                setScreenFlash(state);
                return;
            }

            try {
                await videoTrack.applyConstraints({
                    advanced: [{ torch: state }]
                });
            } catch (error) {
                console.warn('ç„¡æ³•ä½¿ç”¨æ‰‹é›»ç­’ APIï¼Œå°‡ä½¿ç”¨è¢å¹•é–ƒçˆã€‚', error);
                // åŸ·è¡Œè¢å¹•é–ƒçˆå‚™ç”¨æ–¹æ¡ˆ
                setScreenFlash(state);
            }
        }

        /**
         * è¢å¹•é–ƒçˆå‚™ç”¨æ–¹æ¡ˆ
         * @param {boolean} state - true ç‚ºäº®ç™½å±, false ç‚ºç°å±
         */
        function setScreenFlash(state) {
            body.classList.toggle('flash-screen', state);
            if (state) {
                statusDisplay.textContent = 'ç‹€æ…‹ï¼šç™¼é€ SOS ä¸­ (è¢å¹•é–ƒçˆå‚™ç”¨)';
            } else if (!isRunning) {
                statusDisplay.textContent = 'ç‹€æ…‹ï¼šå·²åœæ­¢';
            }
        }

        // --- SOS é‚è¼¯å’Œå¾ªç’° ---

        /**
         * å¾ªç’°åŸ·è¡Œ SOS åºåˆ—
         * @param {number} index - ç•¶å‰åºåˆ—æ­¥é©Ÿçš„ç´¢å¼•
         */
        function loopSOS(index) {
            if (!isRunning) return;

            const step = MORSE_CODE_SEQUENCE[index % MORSE_CODE_SEQUENCE.length];
            const nextIndex = (index + 1);

            // åŸ·è¡Œç•¶å‰æ­¥é©Ÿï¼šé–‹å•Ÿæˆ–é—œé–‰æ‰‹é›»ç­’/è¢å¹•
            setTorch(step.on);

            // è¨­å®šè¨ˆæ™‚å™¨åŸ·è¡Œä¸‹ä¸€å€‹æ­¥é©Ÿ
            timerId = setTimeout(() => {
                loopSOS(nextIndex);
            }, step.duration);
        }

        /**
         * åœæ­¢ SOS è¨Šè™Ÿ
         */
        function stopSOS() {
            isRunning = false;
            clearTimeout(timerId);

            // é—œé–‰æ‰‹é›»ç­’æˆ–æ¸…é™¤è¢å¹•é–ƒçˆ
            setTorch(false);

            // åœæ­¢ä¸¦é‡‹æ”¾ç›¸æ©Ÿè³‡æº
            if (videoTrack) {
                videoTrack.stop();
                videoTrack = null;
            }

            // æ›´æ–°æŒ‰éˆ•å’Œç‹€æ…‹
            button.textContent = 'å•Ÿå‹• SOS è¨Šè™Ÿ';
            button.classList.remove('stop');
            statusDisplay.textContent = 'ç‹€æ…‹ï¼šå·²åœæ­¢';
        }

        /**
         * å•Ÿå‹• SOS è¨Šè™Ÿ (ä¸»è¦æµç¨‹)
         */
        async function startSOS() {
            if (isRunning) return;
            isRunning = true;
            statusDisplay.textContent = 'ç‹€æ…‹ï¼šæ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...';

            // æ­¥é©Ÿ 1: è«‹æ±‚ç›¸æ©Ÿæ¬Šé™ä¸¦å–å¾—è¦–è¨Šè»Œé“
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment' // è«‹æ±‚å¾Œç½®é¡é ­
                    }
                });
                videoTrack = stream.getVideoTracks()[0];
                statusDisplay.textContent = 'ç‹€æ…‹ï¼šæ¬Šé™å·²å–å¾—ï¼Œæ­£åœ¨ç™¼é€ SOS ä¸­ (æ‰‹é›»ç­’)';

            } catch (error) {
                console.error('ç„¡æ³•å–å¾—ç›¸æ©Ÿæ¬Šé™:', error);
                // å¦‚æœæ¬Šé™è¢«æ‹’çµ•ï¼Œå‰‡ç„¡æ³•ä½¿ç”¨æ‰‹é›»ç­’ï¼Œä½†ä»å¯ä»¥å˜—è©¦è¢å¹•é–ƒçˆ
                videoTrack = null; // ç¢ºä¿èµ°å‚™ç”¨æ–¹æ¡ˆ
                statusDisplay.textContent = 'ç‹€æ…‹ï¼šç„¡æ³•å­˜å–æ‰‹é›»ç­’ï¼Œå°‡ä½¿ç”¨è¢å¹•é–ƒçˆå‚™ç”¨ã€‚';
            }

            // æ›´æ–°æŒ‰éˆ•
            button.textContent = 'åœæ­¢ SOS è¨Šè™Ÿ';
            button.classList.add('stop');

            // å•Ÿå‹• SOS å¾ªç’°
            loopSOS(0);
        }

        // --- äº‹ä»¶ç›£è½ ---

        button.addEventListener('click', () => {
            if (isRunning) {
                stopSOS();
            } else {
                startSOS();
            }
        });

        // ç¢ºä¿åœ¨é é¢å¸è¼‰æ™‚åœæ­¢æ‰‹é›»ç­’
        window.addEventListener('beforeunload', stopSOS);
    </script>
</body>
</html>
